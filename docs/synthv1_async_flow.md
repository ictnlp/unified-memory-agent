# Synthv1 Async åˆæˆæ•°æ®æµç¨‹æ–‡æ¡£

## ğŸ“‹ æ¦‚è¿°

`synthv1_async.py` æ˜¯ä¸€ä¸ªå¼‚æ­¥çš„è´¹ç”¨è¿½è¸ªå¯¹è¯æ•°æ®åˆæˆç³»ç»Ÿï¼Œç”¨äºç”Ÿæˆé«˜è´¨é‡çš„å¤šè½®å¯¹è¯æ•°æ®é›†ï¼ŒåŒ…å«è‡ªç„¶è¯­è¨€å¯¹è¯å’Œç›¸åº”çš„æ¶ˆè´¹äº¤æ˜“è®°å½•ï¼Œä»¥åŠåŸºäºè¿™äº›æ•°æ®çš„é—®ç­”å¯¹ã€‚

**ä¸»è¦ç”¨é€”**ï¼š
- ç”Ÿæˆè®°å¿†å‹å¯¹è¯ AI çš„è®­ç»ƒå’Œè¯„ä¼°æ•°æ®
- åˆ›å»ºè´¹ç”¨è¿½è¸ªåœºæ™¯çš„å¯¹è¯æ•°æ®é›†
- è‡ªåŠ¨ç”Ÿæˆé—®ç­”å¯¹ç”¨äºæµ‹è¯•è®°å¿†èƒ½åŠ›

## ğŸ—ï¸ æ ¸å¿ƒæ¦‚å¿µ

### 1. æ¶ˆè´¹åœºæ™¯ (CONSUMPTION_SCENES)

ç³»ç»Ÿå®šä¹‰äº† 8 å¤§ç±»æ¶ˆè´¹åœºæ™¯ï¼Œæ¯ä¸ªåœºæ™¯åŒ…å«å¤šä¸ªå­åœºæ™¯ï¼š

- **é¤é¥® (Dining)**: å¿«é¤ã€é¤å…ã€å’–å•¡ã€å¥¶èŒ¶ã€çƒ§çƒ¤ã€ç«é”…ã€å°åƒã€å¤–å–
- **äº¤é€š (Transportation)**: åœ°é“ã€å…¬äº¤ã€å‡ºç§Ÿè½¦ã€æ±½æ²¹ã€åœè½¦ã€ç«è½¦ã€é£æœº
- **è´­ç‰© (Shopping)**: æœè£…ã€ç”µå­äº§å“ã€æ—¥ç”¨å“ã€åŒ–å¦†å“ã€ä¹¦ç±ã€æ‚è´§ã€å®¶å…·
- **å¨±ä¹ (Entertainment)**: ç”µå½±ã€KTVã€æ¸¸æˆã€å¥èº«æˆ¿ã€æ—…æ¸¸ã€æ¼”å”±ä¼šã€å¯†å®¤é€ƒè„±
- **æ°´ç”µè´¹ (Utilities)**: æ°´ç”µã€ç‰©ä¸šè´¹ã€ç”µè¯è´¹ã€ç½‘è´¹ã€ç‡ƒæ°”è´¹ã€æˆ¿ç§Ÿ
- **åŒ»ç–— (Medical)**: è¯å“ã€çœ‹ç—…ã€ä½“æ£€ã€ç‰™ç§‘ã€çœ¼é•œ
- **æ•™è‚² (Education)**: åŸ¹è®­è¯¾ç¨‹ã€ä¹¦ç±èµ„æ–™ã€åœ¨çº¿è¯¾ç¨‹ã€è€ƒè¯•æŠ¥åã€å­¦è´¹
- **å…¶ä»– (Other)**: è½¬è´¦ã€çº¢åŒ…ã€ææ¬¾ã€å® ç‰©ã€ç¾å®¹ç¾å‘

### 2. æ•°æ®ç»“æ„

#### Transaction (äº¤æ˜“è®°å½•)
```python
{
    "date": "2024-01-15",           # æ—¥æœŸ
    "scene": "Dining",               # åœºæ™¯
    "subscene": "Restaurant",        # å­åœºæ™¯
    "amount": 45.5,                  # é‡‘é¢
    "description": "åˆé¤",           # æè¿°
    "session_index": 0               # æ‰€å±ä¼šè¯ç´¢å¼•
}
```

#### Question (é—®é¢˜)
```python
{
    "qid": "synth_abc123_0",         # é—®é¢˜ID
    "query": "ä»...åˆ°...èŠ±äº†å¤šå°‘é’±ï¼Ÿ", # é—®é¢˜æ–‡æœ¬
    "answer": "123.45",              # ç­”æ¡ˆ
    "position": 49,                  # é—®é¢˜ä½ç½®ï¼ˆchunkç´¢å¼•ï¼‰
    "category": "time_range_scene_amount"  # é—®é¢˜ç±»å‹
}
```

## ğŸ”„ æ•°æ®åˆæˆæµç¨‹

### é˜¶æ®µ 1: åˆå§‹åŒ–ä¸å‡†å¤‡

```
1. è®¾ç½®å‚æ•°
   â”œâ”€ num_sessions: ä¼šè¯æ•°é‡ï¼ˆé»˜è®¤50ï¼‰
   â”œâ”€ num_questions: é—®é¢˜æ•°é‡ï¼ˆé»˜è®¤100ï¼‰
   â”œâ”€ date_range: æ—¶é—´èŒƒå›´ï¼ˆ2024-01-01 åˆ° 2024-12-31ï¼‰
   â””â”€ llm_concurrency: LLMå¹¶å‘æ•°ï¼ˆé»˜è®¤8ï¼‰

2. ç”Ÿæˆæ—¶é—´ç‚¹
   â””â”€ åœ¨å¹´åº¦èŒƒå›´å†…éšæœºç”Ÿæˆ num_sessions ä¸ªä¸é‡å¤çš„æ—¥æœŸ
```

### é˜¶æ®µ 2: ä¼šè¯ç”Ÿæˆ (generate_session)

**å¹¶å‘ç”Ÿæˆå¤šä¸ªä¼šè¯å¯¹è¯**

å¯¹æ¯ä¸ªä¼šè¯ï¼š

```
1. é€‰æ‹©æ¶ˆè´¹åœºæ™¯
   â”œâ”€ éšæœºé€‰æ‹© min_scenes ~ max_scenes ä¸ªåœºæ™¯ï¼ˆé»˜è®¤1-10ï¼‰
   â””â”€ ä»æ‰€æœ‰ (åœºæ™¯, å­åœºæ™¯) å¯¹ä¸­éšæœºé‡‡æ ·

2. æ„å»º Prompt
   â”œâ”€ ç¬¬ä¸€ä¸ªä¼šè¯ï¼šåŒ…å«é—®å€™å’Œæ„å›¾ä»‹ç»
   â””â”€ åç»­ä¼šè¯ï¼šç›´æ¥è®°å½•æ¶ˆè´¹ï¼Œæ— éœ€é—®å€™

3. è°ƒç”¨ LLM ç”Ÿæˆ
   â”œâ”€ è¾“å…¥ï¼šæ—¥æœŸã€åœºæ™¯åˆ—è¡¨ã€è½®æ¬¡èŒƒå›´ï¼ˆ20-50è½®ï¼‰
   â”œâ”€ è¾“å‡ºï¼šJSONæ ¼å¼
   â”‚   â”œâ”€ dialogue: [{role, content}, ...]
   â”‚   â””â”€ transactions: [{scene, subscene, amount, description}, ...]
   â””â”€ è‡ªåŠ¨é‡è¯•ç›´åˆ°æˆåŠŸ

4. è§£æç»“æœ
   â”œâ”€ åˆ›å»º Transaction å¯¹è±¡
   â””â”€ æ„å»ºå¯¹è¯ turnsï¼ˆåŒ…å«æ—¥æœŸå’Œä¼šè¯ç´¢å¼•ï¼‰
```

**ç¤ºä¾‹å¯¹è¯æ ¼å¼**ï¼š
```
[2024-01-15] User said, "Hi, I'd like to record my expenses today."
[2024-01-15] Assistant said, "Of course! What did you spend money on?"
[2024-01-15] User said, "I had lunch at a restaurant, spent 45.5 yuan."
[2024-01-15] Assistant said, "Got it, restaurant lunch 45.5 yuan recorded."
```

### é˜¶æ®µ 3: ä¸Šä¸‹æ–‡æ„å»º

```
1. å°†æ¯ä¸ªä¼šè¯çš„å¯¹è¯ç»„ç»‡æˆ chunk
   â””â”€ æ¯ä¸ª chunk = ä¸€ä¸ªä¼šè¯çš„æ‰€æœ‰å¯¹è¯è½®æ¬¡

2. Chunk æ ¼å¼åŒ–
   â””â”€ æ¯ä¸€è½®å¯¹è¯æ ¼å¼ï¼š[æ—¥æœŸ] è§’è‰² said, "å†…å®¹"
```

### é˜¶æ®µ 4: é—®é¢˜ç”Ÿæˆ (generate_questions)

**åŸºäºæ‰€æœ‰äº¤æ˜“è®°å½•ç”Ÿæˆ 8 ç§ç±»å‹çš„é—®é¢˜**

#### é—®é¢˜ç±»å‹åˆ†å¸ƒ

```
æ€»é—®é¢˜æ•° = num_questions (é»˜è®¤100)
â”œâ”€ Type 1-7: å¹³å‡åˆ†é… 99 ä¸ªé—®é¢˜
â””â”€ Type 8: å›ºå®š 1 ä¸ªé—®é¢˜
```

#### 8 ç§é—®é¢˜ç±»å‹

| ç±»å‹ | æè¿° | ç¤ºä¾‹ | Category |
|-----|------|------|----------|
| Type 1 | æ—¶é—´èŒƒå›´å†…ç‰¹å®šåœºæ™¯çš„æ€»èŠ±è´¹ | "ä»2024-01-01åˆ°2024-01-31åœ¨é¤é¥®ä¸ŠèŠ±äº†å¤šå°‘é’±ï¼Ÿ" | `time_range_scene_amount` |
| Type 2 | æ—¶é—´èŒƒå›´å†…å¤šä¸ªåœºæ™¯çš„æ€»èŠ±è´¹ | "ä»2024-01-01åˆ°2024-01-31åœ¨é¤é¥®ã€äº¤é€šä¸Šæ€»å…±èŠ±äº†å¤šå°‘é’±ï¼Ÿ" | `time_range_multiple_scenes_amount` |
| Type 3 | æ—¶é—´èŒƒå›´å†…çš„æ€»èŠ±è´¹ | "ä»2024-01-01åˆ°2024-01-31æ€»å…±èŠ±äº†å¤šå°‘é’±ï¼Ÿ" | `time_range_total_amount` |
| Type 4 | èŠ±è´¹æœ€å¤šçš„åœºæ™¯ | "ä»2024-01-01åˆ°2024-01-31å“ªä¸ªæ¶ˆè´¹åœºæ™¯èŠ±è´¹æœ€é«˜ï¼Ÿ" | `max_scene` |
| Type 5 | ç‰¹å®šåœºæ™¯äº¤æ˜“æ¬¡æ•°æœ€å¤šçš„æ—¥æœŸ | "å“ªä¸€å¤©é¤é¥®æ¶ˆè´¹çš„æ¬¡æ•°æœ€å¤šï¼Ÿ" | `max_frequency_date` |
| Type 6 | æœ€å¤§å•ç¬”äº¤æ˜“é‡‘é¢ | "ä»2024-01-01åˆ°2024-01-31æœ€å¤§çš„å•ç¬”äº¤æ˜“é‡‘é¢æ˜¯å¤šå°‘ï¼Ÿ" | `max_single_amount` |
| Type 7 | ç‰¹å®šæ—¥æœŸç‰¹å®šåœºæ™¯çš„èŠ±è´¹ | "2024-01-15åœ¨é¤é¥®ä¸ŠèŠ±äº†å¤šå°‘é’±ï¼Ÿ" | `single_date_scene_amount` |
| Type 8 | æ‰€æœ‰è®°å½•çš„æ€»èŠ±è´¹ | "æ‰€æœ‰è®°å½•çš„æ€»èŠ±è´¹æ˜¯å¤šå°‘ï¼Ÿ" | `total_amount` |

#### é—®é¢˜å¤šæ ·åŒ– (diversify)

å¦‚æœå¯ç”¨å¤šæ ·åŒ–ï¼ˆé»˜è®¤å¯ç”¨ï¼‰ï¼š

```
1. å°†é—®é¢˜åˆ†æ‰¹ï¼ˆæ¯æ‰¹10ä¸ªï¼‰
2. ä½¿ç”¨ LLM é‡å†™é—®é¢˜
   â”œâ”€ ä¿æŒæ ¸å¿ƒå«ä¹‰ä¸å˜
   â”œâ”€ ä¿ç•™å…³é”®ä¿¡æ¯ï¼ˆæ—¥æœŸã€åœºæ™¯åï¼‰
   â””â”€ ä½¿é—®é¢˜æ›´è‡ªç„¶ã€æ›´å£è¯­åŒ–
3. å¹¶å‘å¤„ç†æ‰€æœ‰æ‰¹æ¬¡
```

**ç¤ºä¾‹è½¬æ¢**ï¼š
```
åŸå§‹: "How much was spent on Dining from 2024-01-01 to 2024-01-31?"
å¤šæ ·åŒ–å: "Can you tell me my total dining expenses in January 2024?"
```

### é˜¶æ®µ 5: æ•°æ®è¾“å‡º

```
æœ€ç»ˆè¾“å‡º JSON æ ¼å¼ï¼š
{
    "task_id": "consumption_tracking_abc12345",
    "questions": [...],  // é—®é¢˜åˆ—è¡¨
    "chunks": [...],     // å¯¹è¯chunks
    "metadata": {
        "num_sessions": 50,
        "num_turns": 1234,
        "num_transactions": 345,
        "date_range": {"start": "2024-01-05", "end": "2024-12-28"},
        "scenes": ["Dining", "Transportation", ...],
        "total_amount": 12345.67,
        "transaction_events": [...]  // æ‰€æœ‰äº¤æ˜“è®°å½•
    }
}
```

## ğŸš€ ä½¿ç”¨æ–¹æ³•

### åŸºæœ¬ç”¨æ³•

```bash
# é»˜è®¤é…ç½®ï¼š50ä¸ªä¼šè¯ï¼Œ100ä¸ªé—®é¢˜
python data/synthv1_async.py --out=processed_synth.json

# è‡ªå®šä¹‰å‚æ•°
python data/synthv1_async.py \
    --num_sessions=30 \
    --num_questions=50 \
    --min_turns=10 \
    --max_turns=30 \
    --out=custom_synth.json

# å¿«é€Ÿæ¨¡å¼ï¼ˆç”¨äºæµ‹è¯•ï¼‰
python data/synthv1_async.py --fast --out=test_synth.json
# å¿«é€Ÿæ¨¡å¼: 3ä¸ªä¼šè¯ï¼Œ10ä¸ªé—®é¢˜ï¼Œ5-10è½®å¯¹è¯ï¼Œ1-3ä¸ªåœºæ™¯

# ç”Ÿæˆå¤šä¸ªæ•°æ®é›†
python data/synthv1_async.py \
    --num_records=5 \
    --out=multi_synth.json
```

### å‚æ•°è¯´æ˜

| å‚æ•° | é»˜è®¤å€¼ | è¯´æ˜ |
|-----|--------|------|
| `model` | Qwen/Qwen3-30B-A3B-Instruct-2507 | LLM æ¨¡å‹åç§° |
| `out` | processed_synth.json | è¾“å‡ºæ–‡ä»¶è·¯å¾„ |
| `num_sessions` | 50 | ç”Ÿæˆçš„ä¼šè¯æ•°é‡ |
| `num_questions` | 100 | ç”Ÿæˆçš„é—®é¢˜æ•°é‡ |
| `min_turns` | 20 | æ¯ä¸ªä¼šè¯æœ€å°‘è½®æ¬¡ |
| `max_turns` | 50 | æ¯ä¸ªä¼šè¯æœ€å¤šè½®æ¬¡ |
| `min_scenes` | 1 | æ¯ä¸ªä¼šè¯æœ€å°‘åœºæ™¯æ•° |
| `max_scenes` | 10 | æ¯ä¸ªä¼šè¯æœ€å¤šåœºæ™¯æ•° |
| `no_diversify` | False | æ˜¯å¦ç¦ç”¨é—®é¢˜å¤šæ ·åŒ– |
| `fast` | False | å¿«é€Ÿæ¨¡å¼ï¼ˆç”¨äºæµ‹è¯•ï¼‰ |
| `num_records` | 1 | ç”Ÿæˆæ•°æ®é›†çš„æ•°é‡ |
| `llm_concurrency` | 8 | LLM å¹¶å‘è°ƒç”¨æ•° |

### ä»£ç è°ƒç”¨

```python
from data.synthv1_async import async_main
from openai import AsyncOpenAI

client = AsyncOpenAI(
    base_url="http://localhost:8000/v1",
    api_key="EMPTY"
)

# å¼‚æ­¥è¿è¡Œ
import asyncio
result = asyncio.run(async_main(
    client=client,
    num_sessions=10,
    num_questions=20,
    out="my_dataset.json"
))
```

## âš™ï¸ æ€§èƒ½ä¼˜åŒ–

### 1. å¼‚æ­¥å¹¶å‘

- **ä¼šè¯ç”Ÿæˆ**: æ‰€æœ‰ä¼šè¯å¹¶å‘ç”Ÿæˆï¼ˆå— `llm_concurrency` é™åˆ¶ï¼‰
- **é—®é¢˜å¤šæ ·åŒ–**: æ‰¹é‡å¹¶å‘å¤„ç†
- **å¤šæ•°æ®é›†**: å¹¶å‘ç”Ÿæˆå¤šä¸ªæ•°æ®é›†

### 2. å¹¶å‘æ§åˆ¶

```python
# é€šè¿‡ä¿¡å·é‡é™åˆ¶å¹¶å‘LLMè°ƒç”¨
_CALL_LLM_SEMAPHORE = asyncio.Semaphore(llm_concurrency)
```

### 3. è¿›åº¦æ˜¾ç¤º

- ä½¿ç”¨ `tqdm` å’Œ `tqdm_asyncio` æ˜¾ç¤ºå®æ—¶è¿›åº¦
- æ”¯æŒå¤šæ•°æ®é›†åŒæ—¶æ˜¾ç¤ºè¿›åº¦

## ğŸ“Š è¾“å‡ºç»Ÿè®¡

æ¯æ¬¡ç”Ÿæˆå®Œæˆåä¼šæ˜¾ç¤ºï¼š

```
=== Generating dataset 1/1 ===
Generated 50 dates: 2024-01-05 to 2024-12-28
Total: 1234 turns, 345 transactions
Generated 100 questions

   - Task ID: consumption_tracking_abc12345
   - Sessions: 50
   - Chunks: 50
   - Turns: 1234
   - Transactions: 345
   - Questions: 100
   - Total amount: 12345.67

âœ… Dataset written to: processed_synth.json
```

## ğŸ” è´¨é‡ä¿è¯

### 1. è‡ªåŠ¨é‡è¯•æœºåˆ¶

- LLM è°ƒç”¨å¤±è´¥è‡ªåŠ¨é‡è¯•
- JSON è§£æå¤±è´¥å°è¯•ä¿®å¤ï¼ˆä½¿ç”¨ `json_repair`ï¼‰
- å¼‚å¸¸å¤„ç†ç¡®ä¿æ•°æ®å®Œæ•´æ€§

### 2. æ•°æ®ä¸€è‡´æ€§

- æ‰€æœ‰é—®é¢˜çš„ç­”æ¡ˆéƒ½åŸºäºå®é™…äº¤æ˜“è®°å½•è®¡ç®—
- å»é‡ç¡®ä¿é—®é¢˜æ¨¡æ¿å”¯ä¸€
- æ—¥æœŸä¸¥æ ¼æ’åº

### 3. è‡ªç„¶åº¦ä¼˜åŒ–

- ç¬¬ä¸€ä¸ªä¼šè¯åŒ…å«é—®å€™å’Œæ„å›¾ä»‹ç»
- åç»­ä¼šè¯è‡ªç„¶å»¶ç»­ï¼Œæ— é‡å¤é—®å€™
- é—®é¢˜å¤šæ ·åŒ–æé«˜è‡ªç„¶åº¦

## ğŸ¯ åº”ç”¨åœºæ™¯

1. **è®­ç»ƒè®°å¿†å‹å¯¹è¯ AI**
   - å¤šè½®å¯¹è¯ç†è§£
   - é•¿æœŸè®°å¿†ä¿æŒ
   - ä¿¡æ¯æ£€ç´¢èƒ½åŠ›

2. **è¯„ä¼°ç³»ç»Ÿæ€§èƒ½**
   - æ•°å€¼è®¡ç®—å‡†ç¡®æ€§
   - æ—¶é—´èŒƒå›´ç†è§£
   - å¤šæ¡ä»¶æŸ¥è¯¢

3. **Benchmark æ„å»º**
   - æ ‡å‡†åŒ–æµ‹è¯•é›†
   - å¯é‡ç°çš„è¯„ä¼°
   - å¤šç»´åº¦æŒ‡æ ‡

## ğŸ“ æ³¨æ„äº‹é¡¹

1. **LLM ä¾èµ–**: éœ€è¦ç¨³å®šçš„ LLM API æœåŠ¡
2. **ç”Ÿæˆæ—¶é—´**: 50ä¸ªä¼šè¯çº¦éœ€ 5-10 åˆ†é’Ÿï¼ˆå–å†³äºå¹¶å‘åº¦ï¼‰
3. **è¾“å‡ºå¤§å°**: å®Œæ•´æ•°æ®é›†çº¦ 1-5 MB
4. **è´¨é‡æ§åˆ¶**: å»ºè®®äººå·¥æŠ½æŸ¥ç”Ÿæˆè´¨é‡

## ğŸ”§ æ•…éšœæ’æŸ¥

### å¸¸è§é—®é¢˜

1. **JSON è§£æå¤±è´¥**
   ```bash
   pip install json-repair
   ```

2. **API è¿æ¥è¶…æ—¶**
   - æ£€æŸ¥ `API_CONFIG` é…ç½®
   - è°ƒæ•´ `max_retries` å‚æ•°

3. **å¹¶å‘è¿‡é«˜å¯¼è‡´é™æµ**
   - é™ä½ `llm_concurrency` å€¼
   - è°ƒæ•´ API æœåŠ¡çš„ rate limit

4. **ç”Ÿæˆæ•°æ®ä¸è‡ªç„¶**
   - å¯ç”¨ `diversify` æ¨¡å¼
   - è°ƒæ•´ `temperature` å‚æ•°

## ğŸ“ æ‰©å±•å¼€å‘

### æ·»åŠ æ–°çš„æ¶ˆè´¹åœºæ™¯

ä¿®æ”¹ `CONSUMPTION_SCENES` å­—å…¸ï¼š

```python
CONSUMPTION_SCENES = {
    "YourScene": ["Subscene1", "Subscene2", ...],
    ...
}
```

### æ·»åŠ æ–°çš„é—®é¢˜ç±»å‹

åœ¨ `generate_questions` å‡½æ•°ä¸­æ·»åŠ æ–°ç±»å‹ï¼š

```python
# Type 9: Your custom question type
for _ in range(q_per_type):
    # Your logic here
    question_specs.append({
        "template": "Your question template",
        "answer": "Your answer",
        "category": "your_category"
    })
```

## ğŸ“š ç›¸å…³æ–‡ä»¶

- `EvalDataset.py`: æ•°æ®åŠ è½½å’Œå¤„ç†
- `evaluate_async.py`: è¯„ä¼°è„šæœ¬
- `generate_stats.py`: ç»Ÿè®¡ç”Ÿæˆ

---

**æ–‡æ¡£ç‰ˆæœ¬**: v1.0
**æœ€åæ›´æ–°**: 2025-11-28
**ç»´æŠ¤è€…**: Claude Code
